(function(k){k(window.jQuery,window._,window.ol)})(function(k,n,c){var l=0;k.widget("s3.showMap",{options:{id:"default_map",lat:0,lon:0,zoom:0,layers_osm:[]},_create:function(){this.id=l;l+=1;this.eventNamespace=".s3Map"},_init:function(b){this.refresh()},_destroy:function(){k.Widget.prototype.destroy.call(this)},refresh:function(){var b=this.options,a=this.addLayers();b=new c.Map({layers:a,target:b.id,view:new c.View({center:c.proj.fromLonLat([b.lon,b.lat]),zoom:b.zoom})});this.tooltip=a=k("#"+this.options.id+
" .s3-gis-tooltip");a=new c.Overlay({element:a[0],positioning:"bottom-center",stopEvent:!1,offset:[0,-50]});b.addOverlay(a);this.tooltip_ol=a;this._bindEvents(b)},addLayers:function(){var b=[];this.addLayersOSM(b);this.addLayersGeoJSON(b);return b},addLayersOSM:function(b){for(var a,d,e=this.options.layers_osm||[],g,h,f=0;f<e.length;f++)d=e[f],a=void 0!=d.attribution?[d.attribution]:[c.source.OSM.ATTRIBUTION],g=void 0!=d.maxZoom?d.maxZoom:19,h=void 0!=d.base?d.base:!0,d=void 0!=d.url?d.url:"https://{a-c}.tile.openstreetmap.org/{z}/{x}/{y}.png",
a={attributions:a,maxZoom:g,opaque:h,url:d},b.push(new c.layer.Tile({source:new c.source.OSM(a)}))},addLayersGeoJSON:function(b){var a=this.options,d=a.layers_feature||[],e=a.layers_geojson||[],g=a.layers_georss||[];var h=a.layers_shapefile||[];var f=a.layers_theme||[];d=(a.feature_queries||[]).concat(a.feature_resources||[]).concat(d).concat(e).concat(g).concat(h).concat(f);for(e=0;e<d.length;e++)a=d[e],h=void 0!=a.projection?new c.format.GeoJSON({dataProjection:"EPSG:"+a.projection}):new c.format.GeoJSON({dataProjection:"EPSG:4326"}),
g=this.layerStyle(a),f=a.url,h=new c.source.Vector({url:f,format:h}),g=new c.layer.Vector({source:h,style:g}),void 0!=a.popup_format&&(g.s3_popup_format=a.popup_format),b.push(g)},layerStyle:function(b){if(void 0!==b.marker)b=new c.style.Style({image:new c.style.Icon({src:S3.Ap.concat("/static/img/markers/"+b.marker.i)})});else if(void 0!==b.marker)b=b.style;else{b=new c.style.Fill({color:"rgba(255,255,255,0.4)"});var a=new c.style.Stroke({color:"#3399CC",width:1.25}),d=new c.style.Icon({src:S3.Ap.concat("/static/img/markers/"+
this.options.marker)}),e={Point:new c.style.Style({image:d}),LineString:new c.style.Style({stroke:a}),MultiLineString:new c.style.Style({stroke:a}),MultiPoint:new c.style.Style({image:d}),MultiPolygon:new c.style.Style({stroke:a,fill:b}),Polygon:new c.style.Style({stroke:a,fill:b}),GeometryCollection:new c.style.Style({stroke:a,fill:b,image:d}),Circle:new c.style.Style({stroke:a,fill:b})};b=function(a){return e[a.getGeometry().getType()]}}return b},_deserialize:function(){},_bindEvents:function(b){var a=
this,d,c,g,h,f,k,p,m,q,r,l;b.on("pointermove",function(e){if(e.dragging)a.tooltip.hide();else if(r=b.forEachFeatureAtPixel(e.pixel,function(a,b){return{feature:a,layer:b}})){f=r.feature;m=r.layer;g=f.getGeometry().getCoordinates();a.tooltip_ol.setPosition(g);if(void 0!=m.s3_popup_format){n.templateSettings={interpolate:/\{(.+?)\}/g};q=m.s3_popup_format;l=n.template(q);d={};h={};p=q.split("{");for(e=0;e<p.length;e++)k=p[e].split("}")[0],d[k]=f.get(k),h[k]="";n.defaults(d,h);c=l(d)}else void 0!=d.popup?
c=f.get("popup"):void 0!=f.get("name")?c=f.get("name"):void 0!=m.title&&(e=f.get(m.title),c="object"==typeof e?e.value:e);a.tooltip.html(c).show()}else a.tooltip.hide()})},_unbindEvents:function(){return!0}})});
