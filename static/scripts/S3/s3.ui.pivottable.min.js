/*
 2013-2018 (c) Sahana Software Foundation
 @license MIT

 requires jQuery 1.9.1+
 requires jQuery UI 1.10 widget factory
 requires D3.js 3.4.9+
 requires NVD3.js

*/
var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.findInternal=function(b,m,q){b instanceof String&&(b=String(b));for(var a=b.length,c=0;c<a;c++){var d=b[c];if(m.call(q,d,c,b))return{i:c,v:d}}return{i:-1,v:void 0}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(b,m,q){b!=Array.prototype&&b!=Object.prototype&&(b[m]=q.value)};
$jscomp.getGlobal=function(b){return"undefined"!=typeof window&&window===b?b:"undefined"!=typeof global&&null!=global?global:b};$jscomp.global=$jscomp.getGlobal(this);$jscomp.polyfill=function(b,m,q,a){if(m){q=$jscomp.global;b=b.split(".");for(a=0;a<b.length-1;a++){var c=b[a];c in q||(q[c]={});q=q[c]}b=b[b.length-1];a=q[b];m=m(a);m!=a&&null!=m&&$jscomp.defineProperty(q,b,{configurable:!0,writable:!0,value:m})}};
$jscomp.polyfill("Array.prototype.find",function(b){return b?b:function(b,q){return $jscomp.findInternal(this,b,q).v}},"es6","es3");$jscomp.SYMBOL_PREFIX="jscomp_symbol_";$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};$jscomp.Symbol=function(){var b=0;return function(m){return $jscomp.SYMBOL_PREFIX+(m||"")+b++}}();
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var b=$jscomp.global.Symbol.iterator;b||(b=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("iterator"));"function"!=typeof Array.prototype[b]&&$jscomp.defineProperty(Array.prototype,b,{configurable:!0,writable:!0,value:function(){return $jscomp.arrayIterator(this)}});$jscomp.initSymbolIterator=function(){}};$jscomp.arrayIterator=function(b){var m=0;return $jscomp.iteratorPrototype(function(){return m<b.length?{done:!1,value:b[m++]}:{done:!0}})};
$jscomp.iteratorPrototype=function(b){$jscomp.initSymbolIterator();b={next:b};b[$jscomp.global.Symbol.iterator]=function(){return this};return b};$jscomp.iteratorFromArray=function(b,m){$jscomp.initSymbolIterator();b instanceof String&&(b+="");var q=0,a={next:function(){if(q<b.length){var c=q++;return{value:m(c,b[c]),done:!1}}a.next=function(){return{done:!0,value:void 0}};return a.next()}};a[Symbol.iterator]=function(){return a};return a};
$jscomp.polyfill("Array.prototype.keys",function(b){return b?b:function(){return $jscomp.iteratorFromArray(this,function(b){return b})}},"es6","es3");$jscomp.polyfill("Array.prototype.values",function(b){return b?b:function(){return $jscomp.iteratorFromArray(this,function(b,q){return q})}},"es8","es3");
(function(b,m){var q=0;b.widget("s3.pivottable",{options:{showTotals:!0,ajaxURL:null,defaultChart:{type:"breakdown",axis:"rows"},renderFilter:!0,renderOptions:!0,renderChart:!0,renderTable:!0,collapseFilter:!1,collapseOptions:!0,collapseChart:!0,collapseTable:!1,exploreChart:!1,filterURL:null,filterForm:null,filterTab:null,autoSubmit:1E3,timeout:1E4,thousandSeparator:" ",thousandGrouping:"3",minTickSize:null,precision:null,textAll:"All"},_create:function(){this.id=q;q+=1;this.openRequest=this.chart=
this.table=null;this.eventNamespace=".pt"},_init:function(){var a=b(this.element),c=this.options;this.table=this.data=null;this.chartOptions={currentChart:null,currentDataIndex:null,currentSeriesIndex:null,currentSpectrumIndex:null};this.table_options={hidden:!1};var d=a.find(".pt-chart");this.chart=d.length?d.first():null;c.renderFilter||c.renderOptions?(d="#"+a.attr("id"),c.renderOptions?(b(d+"-options").show(),c.collapseOptions&&(b(d+"-options legend").siblings().toggle(),b(d+"-options legend").children().toggle())):
b(d+"-options").hide(),c.renderFilter?(b(d+"-filters").show(),c.collapseFilter&&(b(d+"-filters legend").siblings().toggle(),b(d+"-filters legend").children().toggle())):b(d+"-options").hide()):a.find(".pt-form-container").hide();c.collapseTable&&(this.table_options.hidden=!0,a.find(".pt-table").hide(),a.find(".pt-show-table").show(),a.find(".pt-hide-table").hide());c.numberFormatter=function(a){var b=c.precision;if(null===a||"undefined"==typeof a)return"-";b=b||0==b?a.toFixed(b):a.toString();b=b.split(".");
a=b[0];b=1<b.length?"."+b[1]:"";a=a.replace(new RegExp("\\B(?=(\\d{"+c.thousandGrouping+"})+(?!\\d))","g"),c.thousandSeparator);return a+b};this.refresh()},_destroy:function(){this.table&&this.table.remove();this.chart&&this.chart.empty()},refresh:function(){var a=b(this.element),c=null;this._unbindEvents();var d=a.find('input[type="hidden"][name="pivotdata"]');d.length&&(c=JSON.parse(b(d).first().val()));c?"count"==c.method&&(this.options.precision=0,this.options.minTickSize=1):(c={empty:!0},a.find(".pt-hide-table").hide(),
a.find(".pt-show-table").hide(),a.find(".pt-export-opt").hide());this.data=c;c.nodata?(a.find(".pt-table").first().empty().append(b('<div class="pt-no-data">'+c.nodata+"</div>")),a.find(".pt-hide-table").hide(),a.find(".pt-show-table").hide(),a.find(".pt-export-opt").hide()):(this._renderTable(),this._renderChartOptions());this._renderChart();c.empty?a.find(".pt-empty").show():a.find(".pt-empty").hide();this.options.autoSubmit?a.find(".pt-submit").hide():a.find(".pt-submit").show();this._bindEvents();
a.find(".pt-throbber").hide()},_renderTable:function(){var a=b(this.element),c=a.find(".pt-table").first().empty();this.table=null;var d=this.data;if(!d.empty)if(this.options.renderTable){var e=d.cells.slice(0),f=d.cols,h=d.rows,k=d.total,g=d.labels,l=!1,p=!1;d=d.facts;1==d.length&&"list"!=d[0][1]&&(1==h.length&&null===h[0][4]&&(l=!0),1==f.length&&null===f[0][4]&&(p=!0));d=this.options;var t=d.showTotals,r;if(p&&t)for(f=[],r=0;r<h.length;r++)e[r]=[];else{var C=function(a,b){return"__other__"!=f[b][0]};
for(r=0;r<h.length;r++)e[r]=e[r].filter(C);f=f.filter(function(a){return"__other__"!=a[0]})}l&&t?(h=[],e=[]):(e=e.filter(function(a,b){return"__other__"!=h[b][0]}),h=h.filter(function(a){return"__other__"!=a[0]}));c=d3.select(c.get(0)).append("table").attr("class","dataTable display report");c.append("thead").call(this._renderHeader,f,g,d).call(this._renderColumns,f,g,p);l&&t||c.append("tbody").call(this._renderRows,this,h,f,g,e,d);t&&c.append("tfoot").call(this._renderFooter,h,f,g,k);this.table=
b(c.node());this.table_options.hidden?(a.find(".pt-show-table").show(),a.find(".pt-hide-table").hide(),a.find(".pt-export-opt").hide()):(a.find(".pt-show-table").hide(),a.find(".pt-hide-table").show(),a.find(".pt-export-opt").show())}else a.find(".pt-show-table").hide(),a.find(".pt-hide-table").hide(),a.find(".pt-export-opt").hide()},_renderHeader:function(a,b,d,e){a=a.append("tr");a.append("th").attr("scope","col").text(d.layer);b.length&&a.append("th").attr({scope:"col",colspan:b.length}).text(d.cols);
e.showTotals&&a.append("th").attr({scope:"col","class":"pt-totals-header pt-row-total",rowspan:2}).text(d.total);return a},_renderColumns:function(a,b,d,e){a=a.append("tr");a.append("th").attr({scope:"col","class":"pt-rows-header"}).text(d.rows);a.selectAll("th.pt-data").data(b).enter().append("th").attr({scope:"col","class":"pt-col-label"}).text(function(a){return e?"":a[4]});return a},_renderRows:function(a,b,d,e,f,h,k){d=a.selectAll("tr.pt-row").data(d).enter().append("tr").attr("class",function(a,
b){return b%2?"odd":"even"});d.append("td").text(function(a){return a[4]});d.selectAll("td.pt-cell").data(function(a,b){return h[b]}).enter().append("td").attr("class","pt-cell").each(b._renderCell,f);k.showTotals&&d.append("td").attr("class","pt-row-total").text(function(a){return a[2][0]});return d},_renderCell:function(a,c,d){c=d3.select(this);for(var e=a.items,f,h=0,k=e.length;h<k;h++){f=e[h];var g=c.append("div").attr("class","pt-cell-value");null===f?g.text(d.none):b.isArray(f)?g.append("ul").selectAll("li").data(f).enter().append("li").html(function(a){return a}):
g.text(f);f=a.keys[h];e&&f&&f.length&&(b(g.node()).data("keys",f).data("fact",h),g.append("div").attr("class","pt-cell-zoom"));1<k-h&&g.append("span").text(" / ")}},_renderFooter:function(a,b,d,e,f){b=b.length%2?"odd":"even";a=a.append("tr").attr("class",b+" pt-totals-row");a.append("th").attr({"class":"pt-totals-header",scope:"row"}).text(e.total);a.selectAll("td.pt-col-total").data(d).enter().append("td").attr("class","pt-col-total").text(function(a){return a[2][0]});a.append("td").attr("class",
"pt-total").text(f);return a},_renderChartOptions:function(){var a=b(this.element),c=a.find(".pt-chart-controls").first().empty(),d=this.data;if(!d.empty&&this.options.renderChart){d=d.labels;var e=a.attr("id");a=d.layer;var f=d.rows,h=d.cols,k=d.per,g=b('<div class="pt-chart-opts">'),l=e+"-pchart-rows",p=e+"-vchart-rows",t=e+"-hchart-rows",r=e+"-schart-rows",C=e+"-pchart-cols",n=e+"-vchart-cols",m=e+"-hchart-cols";e+="-schart-cols";a&&b(g).append(b('<span class="pt-chart-label">'+a+": </span>"));
f&&b(g).append(b('<div id="'+l+'" class="pt-chart-icon pt-pchart"/><div id="'+p+'" class="pt-chart-icon pt-vchart"/><span class="pt-chart-label">'+k+" "+f+"</span>"));h&&b(g).append(b('<div id="'+C+'" class="pt-chart-icon pt-pchart"/><div id="'+n+'" class="pt-chart-icon pt-vchart"/><span class="pt-chart-label">'+k+" "+h+"</span>"));f&&h&&b(g).append(b('<span class="pt-chart-label">| '+d.breakdown+': </span><div id="'+r+'" class="pt-chart-icon pt-schart"/><div id="'+t+'" class="pt-chart-icon pt-hchart"/><span class="pt-chart-label">'+
k+" "+f+'</span><div id="'+e+'"  class="pt-chart-icon pt-schart"/><div id="'+m+'"  class="pt-chart-icon pt-hchart"/><span class="pt-chart-label">'+k+" "+h+"</span>"));b(c).append(g)}},_truncateLabel:function(a,b){return a&&a.length>b?a.substring(0,b-3).replace(/\s+$/g,"")+"...":a},_renderChart:function(a){var c=b(this.element),d=this.data;c.find(".pt-chart-contents").hide();if(c=this.chart)if(b(c).unbind("plothover").unbind("plotclick").empty(),!d.empty&&this.options.renderChart)if(!1===a)this.options.collapseChart=
!0;else{c=this.options.collapseChart;if("undefined"==typeof a||!a){if(c)return;a=this.chartOptions.currentChart}if("undefined"==typeof a||!a){if(c)return;a=this.options.defaultChart}if("undefined"!=typeof a&&a){this.options.collapseChart=!1;this.chartOptions.currentChart=a;c=a.type;a=a.axis;var e=d.labels,f=e.per,h=e.layer+" "+f+" "+e.rows;e=e.layer+" "+f+" "+e.cols;f=d.filter;var k=f[0],g=f[1];"piechart"==c?"rows"==a?this._renderPieChart(d.rows,h,k):this._renderPieChart(d.cols,e,g):"barchart"==c?
"rows"==a?this._renderBarChart(d.rows,d.facts,h,k):this._renderBarChart(d.cols,d.facts,e,g):"breakdown"==c?"rows"==a?this._renderBreakDown(d,0,h,f):this._renderBreakDown(d,1,e,f):"spectrum"==c&&this._renderSpectrum(d,a,f)}}},_renderPieChart:function(a,c,d){var e=this.chart;if(e){b(e).css({height:"360px"}).closest(".pt-chart-contents").show().css({width:"98%"});c?b(e).siblings(".pt-chart-title").html("<h4>"+c+"</h4>"):b(e).siblings(".pt-chart-title").empty();var f=[],h=0;for(c=0;c<a.length;c++){var k=
a[c];!k[1]&&0<=k[2][0]&&(f.push({index:k[0],label:k[4],value:k[2][0],key:k[3]}),h+=k[2][0])}var g=this;g.chartOptions.currentDataIndex=null;var l=function(a){var c=a.index;if(g.chartOptions.currentDataIndex!=c){g._removeChartTooltip();g.chartOptions.currentDataIndex=c;a=a.data;var d=a.value,e=d3.event;g._renderChartTooltip(e.pageX,e.pageY,'<div class="pt-tooltip-label">'+a.label+"</div>"+('<div class="pt-tooltip-text">'+d+" ("+Math.round(d/h*100)+"%)</div>"));b(".pt-tooltip-label").css({color:nv.utils.defaultColor()({},
c)})}};nv.addGraph(function(){var a=nv.models.pieChart().x(function(a){return a.label}).y(function(a){return a.value}).labelsOutside(!1).labelType("percent").labelThreshold(.03).showLegend(!0);a.tooltip.enabled(!1);a.legend.align(!0).rightAlign(!1);a.pie.dispatch.on("elementMouseover",l).on("elementMouseout",function(){b(".pt-tooltip").remove();g.chartOptions.currentDataIndex=null;g.chartOptions.currentSeriesIndex=null});if(g.options.exploreChart&&d)a.pie.dispatch.on("elementClick",function(a){a=
a.data;g._chartExplore([["__other__"==a.index?d+"__belongs":d,a.key]])});d3.select(b(e).get(0)).append("svg").attr("class","nv").datum(f).transition().duration(1200).call(a);nv.utils.windowResize(a.update);return a})}},_renderBarChart:function(a,c,d,e){var f=this.chart;if(f){b(f).closest(".pt-chart-contents").show().css({width:"96%"});for(var h=[],k=this._truncateLabel,g,l,p,t=0;t<c.length;t++){g={key:c[t][2]};l=[];for(var r=0;r<a.length;r++)p=a[r],l.push({label:p[4],value:p[2][t],filterIndex:p[0],
filterKey:p[3]});g.values=l;h.push(g)}b(f).css({height:"360px"});d?b(f).siblings(".pt-chart-title").html("<h4>"+d+"</h4>"):b(f).siblings(".pt-chart-title").empty();var m=function(a){a=a.data;return'<div class="pt-tooltip"><div class="pt-tooltip-label" style="color:'+nv.utils.defaultColor()({},a.index)+'">'+a.label+'</div><div class="pt-tooltip-text">'+a.value+"</div></div>"},n=this,q=this.options.numberFormatter;nv.addGraph(function(){if(1<h.length){var a=nv.models.multiBarChart().x(function(a){return a.label}).y(function(a){return a.value}).staggerLabels(!0).showControls(!1);
var c=a.multibar}else a=nv.models.discreteBarChart().x(function(a){return a.label}).y(function(a){return a.value}).staggerLabels(!0).showValues(!0),a.valueFormat(q),c=a.discretebar;a.tooltip.contentGenerator(m);a.yAxis.tickFormat(q);a.xAxis.tickFormat(function(a){return k(a,18)});d3.select(b(f).get(0)).append("svg").attr("class","nv").datum(h).transition().duration(500).call(a);if(n.options.exploreChart&&e)c.dispatch.on("elementClick",function(a){var b=a.data.filterKey;null===b&&(b="None");var c=
e;"__other__"==a.data.filterIndex&&(c+="__belongs");n._chartExplore([[c,b]])});nv.utils.windowResize(a.update);return a})}},_renderBreakDown:function(a,c,d,e){var f=this.chart;if(f){b(f).closest(".pt-chart-contents").show().css({width:"96%"});var h=a.cells,k=[],g=[];if(0===c){var l=a.rows;var p=a.cols;a=function(a,b){return h[k[a]][g[b]].values[0]};var t=e[0];var r=e[1]}else l=a.cols,p=a.rows,a=function(a,b){return h[g[b]][k[a]].values[0]},t=e[1],r=e[0];var m;e=[];c=[];var n=0;for(m=l.length;n<m;n++)l[n][1]||
(e.push(l[n]),k.push(n));n=0;for(m=p.length;n<m;n++)p[n][1]||(c.push(p[n]),g.push(n));var q=[];for(l=0;l<c.length;l++){p={key:c[l][4],filterIndex:c[l][0],filterKey:c[l][3]};n=[];for(m=0;m<e.length;m++)n.push({label:e[m][4],filterIndex:e[m][0],filterKey:e[m][3],value:a(m,l)});p.values=n;q.push(p)}a=Math.max(e.length*Math.max(16*(c.length+1),50)+70,360);b(f).css({height:a+"px"});d?b(f).siblings(".pt-chart-title").html("<h4>"+d+"</h4>"):b(f).siblings(".pt-chart-title").empty();var x=function(a){a=a.data;
return'<div class="pt-tooltip"><div class="pt-tooltip-label" style="color:'+nv.utils.defaultColor()({},a.index)+'">'+a.series+'</div><div class="pt-tooltip-text">'+a.label+': <span class="pt-tooltip-value">'+a.value+"</span></div></div>"},y=this,u=this.options.numberFormatter,z=this._truncateLabel;nv.addGraph(function(){var a=nv.models.multiBarHorizontalChart().x(function(a){return a.label}).y(function(a){return a.value}).margin({top:20,right:20,bottom:20,left:175}).showValues(!0).duration(350).showControls(!0);
a.tooltip.contentGenerator(x);a.valueFormat(u);a.yAxis.tickFormat(u);a.xAxis.tickFormat(function(a){return z(a,24)});d3.select(b(f).get(0)).append("svg").attr("class","nv").datum(q).call(a);if(y.options.exploreChart&&t&&r)a.multibar.dispatch.on("elementClick",function(a){a=a.data;var b=d3.event.currentTarget.parentElement.__data__,c=b.filterKey;null===c&&(c="None");b="__other__"==b.filterIndex?r+"__belongs":r;var d=a.filterKey;null===d&&(d="None");y._chartExplore([["__other__"==a.filterIndex?t+"__belongs":
t,d],[b,c]])});nv.utils.windowResize(a.update);return a})}},_renderSpectrum:function(a,c,d){var e=this.chart;if(e){var f=this,h=a.cells,k=a.labels;if("rows"==c){var g=a.rows;var l=a.cols;c=k.rows;var p=k.cols;var t=d[0];var r=d[1];var q=function(a,b){return h[a][b]}}else g=a.cols,l=a.rows,c=k.cols,p=k.rows,t=d[1],r=d[0],q=function(a,b){return h[b][a]};var n=function(a,b){return null===a?l[b]:null===b?g[a]:q(a,b)},B=function(a,b){b===m&&(b="silver");for(var c=[],d,e,f=0;f<l.length;f++)d=n(null,f),
e=null===a?d[2][0]:n(a,f).values[0],!d[1]&&0<=d[2][0]&&c.push({filterIndex:d[0],filterKey:d[3],label:d[4],value:e,color:b});return c},x=[],y=0;for(d=0;d<g.length;d++){var u=n(d,null);!u[1]&&0<=u[2][0]&&(x.push({position:d,filterIndex:u[0],filterKey:u[3],label:u[4],value:u[2][0]}),y+=u[2][0])}f.chartOptions.currentDataIndex=null;b(e).removeAttr("style").closest(".pt-chart-contents").css({width:"98%",height:"auto"}).show();b(e).siblings(".pt-chart-title").empty();d=b('<div class="pt-spectrum-pie">').appendTo(e);
e=b('<div class="pt-spectrum-bar">').appendTo(e);var z=this.options.numberFormatter,H=this._truncateLabel,v=nv.models.discreteBarChart().x(function(a){return a.label}).y(function(a){return a.value}).color(["silver"]).staggerLabels(!0).showValues(!0);v.tooltip.contentGenerator(function(a){a=a.data;return'<div class="pt-tooltip"><div class="pt-tooltip-label" style="color:'+(a.color||["silver"])+'">'+a.label+'</div><div class="pt-tooltip-text">'+z(a.value)+"</div></div>"});v.valueFormat(z);v.yAxis.tickFormat(z);
v.xAxis.tickFormat(function(a){return H(a,18)});var D=d3.select(b(e).get(0)).append("svg").attr("class","nv");e=Math.floor(d.width()/2)-30;var w=nv.models.pieChart().x(function(a){return a.label}).y(function(a){return a.value}).height(280).width(e).margin({top:-20,left:20}).labelType("percent").labelThreshold(.1).showLegend(!1).donut(!0).donutRatio(.35);w.tooltip.enabled(!1);w.legend.align(!0).rightAlign(!1);w.pie.startAngle(function(a){return a.startAngle/2-Math.PI/2}).endAngle(function(a){return a.endAngle/
2-Math.PI/2});w.pie.dispatch.on("elementMouseover",function(a){var c=a.index;if(f.chartOptions.currentDataIndex!=c){f._removeChartTooltip();f.chartOptions.currentDataIndex=c;a=a.data;var d=a.value,e=d3.event;f._renderChartTooltip(e.pageX,e.pageY,'<div class="pt-tooltip-label">'+a.label+"</div>"+('<div class="pt-tooltip-text">'+d+" ("+Math.round(d/y*100)+"%)</div>"));b(".pt-tooltip-label").css({color:nv.utils.defaultColor()({},c)})}}).on("elementMouseout",function(){b(".pt-tooltip").remove();f.chartOptions.currentDataIndex=
null;f.chartOptions.currentSeriesIndex=null});var E=d3.select(b(d).get(0)).append("svg").attr("class","nv").style({"min-width":e-30+"px"});e=d3.select(b(d).get(0)).append("div").attr("class","pt-spectrum-form");e.append("h4").html(k.layer+" "+k.per+" "+p);e.append("label").html(c+":");var A=e.append("select");A.append("option").attr("value","null").style("font-weight","bold").html(f.options.textAll);A.selectAll(".pt-series-item").data(x).enter().append("option").attr("class","pt-series-item").attr("value",
function(a,b){return b}).html(function(a){return a.label});e.append("label").html(k.total+":");var G=e.append("span").text(a.total),F=function(b){if(null===b||f.chartOptions.currentSpectrumIndex==b){var c=function(a,b){return nv.utils.defaultColor()({},b)};E.selectAll(".nv-slice").style("fill",c).style("stroke",c);c=B(null);D.datum([{key:null,filterIndex:null,filterKey:null,values:c}]);v.update();f.chartOptions.currentSpectrumIndex=null;A.property("value","null");G.text(a.total)}else{var d=x[b],e=
nv.utils.defaultColor()({},b);c=function(a,c){return c==b?e:"silver"};E.selectAll(".nv-slice").style("fill",c).style("stroke",c);c=B(d.position,e);D.datum([{key:d.position,filterIndex:d.filterIndex,filterKey:d.filterKey,values:c}]);v.update();f.chartOptions.currentSpectrumIndex=b;A.property("value",b);G.text(x[b].value)}};w.pie.dispatch.on("elementClick",function(a){F(a.index)});A.on("change.pt",function(){var a=d3.select(this).property("value");"null"==a?F(null):F(a)});nv.addGraph(function(){E.datum(x).transition().duration(1200).call(w);
nv.utils.windowResize(w.update);return w});nv.addGraph(function(){D.datum([{key:null,filterIndex:null,filterKey:null,values:B(null)}]).transition().duration(500).call(v);if(f.options.exploreChart&&t&&r)v.discretebar.dispatch.on("elementClick",function(a){var b=a.data,c=d3.event.currentTarget.parentElement.__data__;a=c.filterIndex;c=c.filterKey;var d=b.filterIndex;b=b.filterKey;var e=[];null!==a&&e.push(["__other__"==a?t+"__belongs":t,c||"None"]);null!==d&&e.push(["__other__"==d?r+"__belongs":r,b||
"None"]);f._chartExplore(e)});nv.utils.windowResize(v.update);return v})}},_chartExplore:function(a){var c=this.options,d=b(this.element).closest(".ui-tabs"),e=c.filterTab;if(d.length&&!1!==e)c=(c=c.filterForm)?b("#"+c):m,S3.search.setCurrentFilters(c,a),a=e?b("#"+e).index():0,d.tabs("option","active",a);else if(d=c.filterURL)a=this._updateURL(d,a),window.open(a,"_blank")},_renderChartTooltip:function(a,c,d){b('<div class="pt-tooltip">'+d+"</div>").css({position:"absolute",display:"none",top:c-50,
left:a+10,border:"1px solid #999",padding:"10px","min-height":"50px","max-width":"240px","z-index":"501","background-color":"white",color:"#000",opacity:.95}).appendTo("body").fadeIn(200)},_removeChartTooltip:function(){b(".pt-tooltip").remove();this.chartOptions.currentDataIndex=null;this.chartOptions.currentSeriesIndex=null},_getOptions:function(){var a="#"+b(this.element).attr("id");return{rows:b(a+"-rows").val(),cols:b(a+"-cols").val(),fact:b(a+"-fact").val(),totals:b(a+"-totals").is(":checked")?
1:0}},_getFilters:function(){var a="#"+b(this.element).attr("id"),c=null;a=b(a+"-filters");if(a.length)try{c=S3.search.getCurrentFilters(a.first())}catch(d){}return c},_updateURL:function(a,b){var c=[],e={},f;if(b){var h=0;for(f=b.length;h<f;h++){var k=b[h];var g=k[0];e[g]=!0;c.push(g+"="+k[1])}}b=this.options.ajaxURL.split("?");if(1<b.length){k=b[1].split("&");b={};h=0;for(f=k.length;h<f;h++){var l=k[h].split("=");1<l.length&&(g=decodeURIComponent(l[0]),e[g]||(c.push(g+"="+decodeURIComponent(l[1])),
b[g]=!0))}for(g in b)e[g]=!0}b=a.split("?");if(1<b.length)for(k=b[1].split("&"),h=0,f=k.length;h<f;h++)l=k[h].split("="),1<l.length&&(g=decodeURIComponent(l[0]),e[g]||c.push(g+"="+decodeURIComponent(l[1])));a=c.join("&");c=b[0];a&&(c=c+"?"+a);return c},_updateAjaxURL:function(a,c,d){var e=this.options.ajaxURL.split("?"),f=[],h=!1;if(1<e.length){var k=e[1];k=k.split("&")}else k="",k=[];if(a)for(p in a){var g=a[p];var l=p+"="+g;"totals"==p?this.options.showTotals=g?!0:!1:h||-1!=b.inArray(l,k)||(h=!0);
f.push(l)}var p={};var m={},r;if(c){var q=function(a){var b,c,d=[];["contains","anyof","belongs","eq"].forEach(function(e){b=new RegExp("__"+e+"$","g");a.match(b)?c=b:d.push(e)});c&&d.forEach(function(b){m[a.replace(c,"__"+b)]=!0})};g=0;for(r=c.length;g<r;g++){l=c[g];var n=l[0];l=l[1];q(n);null===l?p[n]||(m[n]=!0):(m[n]&&(m[n]=!1),l=n+"="+encodeURIComponent(l),p[n]?p[n].push(l):p[n]=[l])}}g=0;for(r=k.length;g<r;g++)l=k[g].split("="),1<l.length&&(n=decodeURIComponent(l[0]),l=decodeURIComponent(l[1]),
m[n]?h=!0:p[n]?h||-1!=b.inArray(n+"="+l,p[n])||(h=!0):"aggregate"!=n&&(a&&a.hasOwnProperty(n)||f.push(k[g])));for(n in p)for(g=0,r=p[n].length;g<r;g++)h||-1!=b.inArray(p[n][g],k)||(h=!0),f.push(p[n][g]);a=f.join("&");e=e[0];a&&(e=e+"?"+a);if(d)return e;this.options.ajaxURL=e;return h},_setExtension:function(a,b){var c=document.createElement("a");c.href=a;a=c.pathname.split("/");var e=[];a.length&&(a.forEach(function(a){var b=a.lastIndexOf(".");-1!=b?e.push(a.slice(0,b)):e.push(a)}),e[e.length-1]+=
"."+b,c.pathname=e.join("/"));var f=c.search;f&&(e=f.slice(1).split().filter(function(a){return"format"!=a.split("=")[0]}),a.length||e.push("format="+b),c.search="?"+e.join("&"));return c.href},reload:function(a,c,d){d="undefined"!=typeof d?d:!0;"undefined"==typeof c&&(c=this._getFilters());var e=this,f=this.element,h=f.find('input[type="hidden"][name="pivotdata"]');if(h.length){f.find(".pt-throbber").show();if(a||c)var k=this._updateAjaxURL(a,c);k||d?(a=this.options.ajaxURL,c=this.options.timeout,
d=b.ajaxS3,b.searchS3!==m&&(d=b.searchS3),f.find(".pt-empty").hide(),e.openRequest&&(e.openRequest.onreadystatechange=null,e.openRequest.abort()),e.openRequest=d({timeout:c,url:a,dataType:"json",type:"GET",success:function(a){e.openRequest=null;h.first().val(JSON.stringify(a));e.refresh()},error:function(a,b,c){console.log("UNAUTHORIZED"==c?i18n.gis_requires_login:a.responseText)}})):e.refresh()}},_downloadXLS:function(){if(this.element.find('input[type="hidden"][name="pivotdata"]').length){var a=
this._getOptions(),c=this._getFilters();a=this._updateAjaxURL(a,c,!0);a=this._setExtension(a,"xls");b.searchDownloadS3!==m?b.searchDownloadS3(a,"_blank"):window.open(a)}},_bindEvents:function(){var a=this,c=b(this.element),d=this.data,e=this.eventNamespace,f="#"+c.attr("id");b(f+"-options legend").click(function(){b(this).siblings().toggle();b(this).children().toggle()});b(f+"-filters legend").click(function(){b(this).siblings().toggle();b(this).children().toggle()});c.find(".pt-hide-table").click(function(){a.table_options.hidden=
!0;c.find(".pt-table").hide();b(this).siblings(".pt-show-table").show();c.find(".pt-export-opt").hide();b(this).hide()});c.find(".pt-show-table").click(function(){a.table_options.hidden=!1;c.find(".pt-table").show();b(this).siblings(".pt-hide-table").show();c.find(".pt-export-opt").show();b(this).hide()});c.find(".pt-export-xls").on("click"+e,function(){a._downloadXLS()});b(f+"-totals").click(function(){var c=b(this).is(":checked");a.options.showTotals!=c&&a.reload({totals:c},null,!1)});b(f+"-rows,"+
f+"-cols,"+f+"-fact").on("change.autosubmit",function(){b(f+"-pt-form").trigger("optionChanged")});if(this.options.autoSubmit){var h=this.options.autoSubmit;b(f+"-pt-form").on("optionChanged",function(){var c=b(this);if(!c.data("noAutoSubmit")){var d=c.data("autoSubmitTimeout");d&&clearTimeout(d);d=setTimeout(function(){var b=a._getOptions(),c=a._getFilters();a.reload(b,c,!1)},h);c.data("autoSubmitTimeout",d)}})}else b(f+"-pt-form input.pt-submit").click(function(){var b=a._getOptions(),c=a._getFilters();
a.reload(b,c,!1)});b(f+" div.pt-table div.pt-cell-zoom").click(function(a){a=b(a.currentTarget);var c=a.closest(".pt-cell-value"),e=c.find(".pt-cell-records");if(0<e.length)e.remove(),a.removeClass("opened");else{var f=c.data("keys");e=c.data("fact");c=d.lookups[d.facts[e][0]];e=b("<div/>").addClass("pt-cell-records");for(var h=b("<ul/>"),k=0;k<f.length;k++)h.append("<li>"+c[f[k]]+"</li>");e.append(h);a.addClass("opened").after(e)}});b(f+"-pchart-rows").click(function(){a._renderChart({type:"piechart",
axis:"rows"})});b(f+"-vchart-rows").click(function(){a._renderChart({type:"barchart",axis:"rows"})});b(f+"-schart-rows").click(function(){a._renderChart({type:"spectrum",axis:"rows"})});b(f+"-hchart-rows").click(function(){a._renderChart({type:"breakdown",axis:"rows"})});b(f+"-pchart-cols").click(function(){a._renderChart({type:"piechart",axis:"cols"})});b(f+"-vchart-cols").click(function(){a._renderChart({type:"barchart",axis:"cols"})});b(f+"-schart-cols").click(function(){a._renderChart({type:"spectrum",
axis:"cols"})});b(f+"-hchart-cols").click(function(){a._renderChart({type:"breakdown",axis:"cols"})});c.find(".pt-hide-chart").click(function(){a._renderChart(!1)})},_unbindEvents:function(){var a=b(this.element),c="#"+a.attr("id"),d=this.eventNamespace;b(c+" div.pt-table div.pt-cell-zoom").unbind("click");b(c+"-options legend").unbind("click");b(c+"-filters legend").unbind("click");b(c+"-totals").unbind("click");b(c+"-rows,"+c+"-cols,"+c+"-fact").unbind("change.autosubmit");b(c+"-pt-form").unbind("optionChanged");
a.find("input.pt-submit").unbind("click");a.find(".pt-export-xls").off("click"+d);b(c+"-pchart-rows,"+c+"-vchart-rows,"+c+"-schart-rows,"+c+"-hchart-rows,"+c+"-pchart-cols,"+c+"-vchart-cols,"+c+"-schart-cols,"+c+"-hchart-cols").unbind("click");a.find(".pt-hide-table").unbind("click");a.find(".pt-show-table").unbind("click");a.find(".pt-hide-chart").unbind("click")}})})(jQuery);
